<!-- 自定义背景区 -->
<view class="bg-layer">
  <image class="bg-image" src="https://images.unsplash.com/photo-1495195134817-aeb325a55b65?ixlib=rb-4.0.3&auto=format&fit=crop&w=1000&q=80" mode="aspectFill"></image>
  <view class="bg-mask"></view>
</view>
<view class="container" style="padding-top: 40px;">
  <!-- 欢迎标语 -->
  <view class="hero-text">
    <view class="hero-title">一饭封神</view>
    <view class="hero-sub">灶间有AI，顿顿米其林！</view>
  </view>

  <!-- 核心操作卡片 -->
  <view class="main-card">
    
    <!-- 步骤 0: 输入食材 -->
    <block wx:if="{{currentStep === 0}}">
      <view class="step-content fade-in">
        
        <!-- 输入区 -->
        <view class="input-section">
          <view class="label">我想用这些食材...</view>
          <view class="input-row">
            <view class="input-wrapper">
              <t-icon name="search" size="24px" color="#999" style="margin-right: 10px;"/>
              <input 
                class="custom-input" 
                placeholder="输入食材名称，如：牛肉" 
                placeholder-class="placeholder-style"
                bindinput="onInput"
                bindconfirm="addIngredient"
                value="{{inputValue}}"
                confirm-type="done"
              />
            </view>
            <view class="add-btn-mini" bindtap="addIngredient">
              <t-icon name="add" size="24px" color="#fff" />
            </view>
          </view>
        </view>

        <!-- 菜篮子展示区 -->
        <view class="basket-section" wx:if="{{basket.length > 0}}">
          <view class="section-title">已选食材</view>
          <view class="basket-list">
            <block wx:for="{{basket}}" wx:key="*this">
              <view class="basket-tag" bindtap="removeIngredient" data-index="{{index}}">
                <text>{{item}}</text>
                <t-icon name="close" size="16px" color="#fff" style="margin-left: 4px; opacity: 0.8;"/>
              </view>
            </block>
          </view>
        </view>

        <!-- 快速选择入口 -->
        <view class="quick-select-trigger" bindtap="openIngredientPopup">
          <text>不知道加什么？点我快速选择</text>
          <t-icon name="app" size="18px" color="#FA8C16" style="margin-left: 6px;"/>
        </view>

        <view class="action-area">
          <button class="generate-btn" bindtap="nextStep" hover-class="btn-hover">
            <text>下一步</text>
            <t-icon name="arrow-right" size="20px" color="#fff" style="margin-left:8px;"/>
          </button>
        </view>
      </view>
    </block>

    <!-- 快速选择弹窗 -->
    <t-popup visible="{{showIngredientPopup}}" bind:visible-change="closeIngredientPopup" placement="bottom">
      <view class="popup-container">
        <view class="popup-header">
          <text>快速添加食材</text>
          <t-icon name="close" size="24px" color="#999" bindtap="closeIngredientPopup" />
        </view>
        <view class="category-container">
          <!-- 左侧分类 Tab -->
          <scroll-view scroll-y class="category-sidebar">
            <block wx:for="{{ingredientCategories}}" wx:key="name">
              <view 
                class="cat-tab {{currentCategoryIndex === index ? 'active' : ''}}" 
                bindtap="switchCategory" 
                data-index="{{index}}"
              >
                {{item.name}}
              </view>
            </block>
          </scroll-view>
          
          <!-- 右侧食材 Grid -->
          <scroll-view scroll-y class="category-content">
            <view class="ing-grid">
              <block wx:for="{{ingredientCategories[currentCategoryIndex].items}}" wx:key="*this">
                <view class="ing-item" bindtap="addFromCategory" data-item="{{item}}">
                  {{item}}
                  <t-icon 
                    wx:if="{{tools.includes(basket, item)}}" 
                    name="check" 
                    size="16px" 
                    color="#FA8C16" 
                    style="margin-left: 4px;"
                  />
                </view>
              </block>
            </view>
          </scroll-view>
        </view>
      </view>
    </t-popup>

    <!-- WXS 工具函数：判断数组包含 -->
    <wxs module="tools">
      module.exports.includes = function(arr, item) {
        return arr.indexOf(item) > -1;
      }
    </wxs>

    <!-- 步骤 1: 选择菜系 -->
    <block wx:if="{{currentStep === 1}}">
      <view class="step-content fade-in">
        <view class="cuisine-section">
          <block wx:for="{{cuisineSections}}" wx:for-item="section" wx:key="title">
            <view class="section-title-cuisine">{{section.title}}</view>
            <view class="cuisine-grid">
              <block wx:for="{{section.items}}" wx:key="id">
                <view 
                  class="cuisine-item {{selectedCuisineId === item.id ? 'active' : ''}}" 
                  bindtap="onSelectCuisine" 
                  data-id="{{item.id}}"
                >
                  <view class="cuisine-emoji">{{item.avatar}}</view>
                  <text class="cuisine-name">{{item.name}}</text>
                </view>
              </block>
            </view>
          </block>
        </view>

        <view class="action-area btn-group">
          <button class="generate-btn btn-secondary" bindtap="prevStep" hover-class="btn-hover">
            <text>上一步</text>
          </button>
          <button class="generate-btn btn-primary" bindtap="onGenerate" hover-class="btn-hover">
            <text>开始生成</text>
            <t-icon name="magic" size="20px" color="#fff" style="margin-left:8px;"/>
          </button>
        </view>
      </view>
    </block>

  </view>
</view>

<!-- 加载动画蒙层 -->
<view class="loading-overlay" wx:if="{{loading}}">
  <view class="loading-content">
    <t-loading theme="circular" size="50px" class="custom-loading-icon" text="" inherit-color />
    <view class="loading-text">{{loadingText}}</view>
  </view>
</view>

<!-- 结果展示弹窗 (全屏风格) -->
<t-popup visible="{{showResult}}" bind:visible-change="closeResult" placement="bottom" style="height: 90vh; border-radius: 24px 24px 0 0; overflow: hidden;">
  <scroll-view scroll-y style="height: 90vh; background: #fff;" wx:if="{{recipe}}">
    
    <!-- 菜谱头图 -->
    <view class="recipe-header">
      <image src="{{recipe.image}}" mode="aspectFill" class="recipe-img"></image>
      <view class="close-btn" bindtap="closeResult">
        <t-icon name="close" size="24px" color="#fff"/>
      </view>
      <view class="recipe-header-content">
        <view class="recipe-title">{{recipe.title}}</view>
        <view class="recipe-tags">
          <view wx:for="{{recipe.tags}}" wx:key="index" class="r-tag">{{item}}</view>
        </view>
      </view>
    </view>

    <!-- 详细内容 -->
    <view class="recipe-body">
      <!-- 仪表盘数据 -->
      <view class="dashboard">
        <view class="dash-item">
          <view class="dash-val">{{recipe.calories}}</view>
          <view class="dash-label">卡路里</view>
        </view>
        <view class="dash-line"></view>
        <view class="dash-item">
          <view class="dash-val">{{recipe.time}}</view>
          <view class="dash-label">时长</view>
        </view>
        <view class="dash-line"></view>
        <view class="dash-item">
          <view class="dash-val" style="font-size: 28rpx;">{{recipe.wine}}</view>
          <view class="dash-label">佐餐推荐</view>
        </view>
      </view>

      <view class="section-header">大厨说</view>
      <view class="recipe-desc">{{recipe.desc}}</view>

      <view class="section-header">烹饪步骤</view>
      <view class="step-list">
        <block wx:for="{{recipe.steps}}" wx:key="index">
          <view class="step-card">
            <view class="step-num">{{index + 1}}</view>
            <view class="step-info">
              <view class="step-title">{{item.title}}</view>
              <view class="step-desc">{{item.desc}}</view>
            </view>
          </view>
        </block>
      </view>

      <!-- 底部留白 -->
      <view style="height: 60px;"></view>
    </view>
  </scroll-view>
</t-popup>